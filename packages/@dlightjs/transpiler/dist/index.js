"use strict";var ge=Object.create;var B=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var be=Object.getOwnPropertyNames;var xe=Object.getPrototypeOf,_e=Object.prototype.hasOwnProperty;var ve=(t,e)=>{for(var s in e)B(t,s,{get:e[s],enumerable:!0})},R=(t,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of be(e))!_e.call(t,r)&&r!==s&&B(t,r,{get:()=>e[r],enumerable:!(n=he(e,r))||n.enumerable});return t};var E=(t,e,s)=>(s=t!=null?ge(xe(t)):{},R(e||!t||!t.__esModule?B(s,"default",{value:t,enumerable:!0}):s,t)),Pe=t=>R(B({},"__esModule",{value:!0}),t);var ze={};ve(ze,{parseDlightFile:()=>ye});module.exports=Pe(ze);var u=E(require("@babel/types"));var F=E(require("@babel/core")),K=E(require("@babel/generator")),d={traverse:F.traverse,generate:t=>(0,K.default)(t).code,parse:t=>F.parse(t,{plugins:[["@babel/plugin-syntax-typescript",{isTSX:!0}],"@babel/plugin-syntax-jsx","@babel/plugin-syntax-do-expressions",["@babel/plugin-syntax-decorators",{legacy:!0}]]})};function H(t,e,s,n){n.body.includes(s)||n.body.unshift(s),s.value.properties.push(u.objectProperty(u.identifier(t),u.arrayExpression(e.map(r=>u.stringLiteral(r)))))}function J(t,e,s){s.body.includes(e)||s.body.unshift(e),!e.value.properties.map(n=>n.key.name).includes(t)&&e.value.properties.push(u.objectProperty(u.identifier(t),u.newExpression(u.identifier("Map"),[])))}function W(t,e){let s=!1,n=t.parentPath;for(;n&&n.node!==e;){if(u.isArrowFunctionExpression(n.node)){s=!0;break}n=n.parentPath}return s}function Ee(t){let e=t.parentPath.node;return u.isAssignmentExpression(e)&&e.left===t.node}function Se(t,e){let s=t.node,n=!1,r=t.parentPath;for(;r&&r.node!==e;){if(u.isAssignmentExpression(r.node)){let o=r.node.left,i=s.type===o.type,a=s.property.name===o.property.name;n=i&&a}r=r.parentPath}return n}function X(t,e){return!W(t,e)&&!Ee(t)&&!Se(t,e)}function w(t){return d.parse(t).program.body[0].body}function q(t,e,s){return[u.classMethod("get",u.identifier(t),[],e),u.classMethod("set",u.identifier(t),[u.identifier("value")],s)]}function U(t){let e=t.value;t.value={type:"ArrowFunctionExpression",params:[],body:e}}function Z(t){return d.generate(t.expression)}function M(t,e){return u.isMemberExpression(t)&&!t.computed&&t.property===e}function j(t,e){return u.isObjectProperty(t)&&t.key===e}var c=E(require("@babel/types"));function Q(t){let e=/htmlTag\((.+)\)/;return e.test(t.tag)?(t.tag=t.tag.replace(e,"$1"),!0):/^[a-z][a-z0-9]*$/.test(t.tag)?(t.tag=`"${t.tag}"`,!0):!1}function Y(t){let e=/tag\((.+)\)/;e.test(t.tag)&&(t.tag=t.tag.replace(e,"$1"))}function G(t){return`${t}
`}function ee(t){return"["+t.map((e,s)=>e.attr.isSubView?`..._$node${s}`:`_$node${s}`).join(", ")+"]"}var g=class{value="";add(e){this.value+=G(e)}shift(e){this.value=G(e)+this.value}addBody(e){this.value+=e.value}};var x=E(require("@babel/types"));function h(t){return"["+t.map(e=>e.startsWith("...")?e:'"'+e+'"').join(", ")+"]"}function k(){return Math.random().toString(20).slice(2,8)}function te(t,e,s=[]){let n=d.parse(`(${t})`),r=[];return d.traverse(n,{MemberExpression(o){e.includes(o.node.property.name)&&X(o)&&r.push(o.node.property.name)}}),r=[...new Set([...r,...s])],r}function ne(t,e,s=[]){let n=d.parse(`(${t})`),r=[];return d.traverse(n,{Identifier(o){for(let{ids:i,propNames:a}of e)i.includes(o.node.name)&&(W(o)||r.push(...a))}}),r=[...new Set([...r,...s])],r}function re(t){return t.match(/[_$a-zA-Z][_$a-zA-Z0-9]*/g)??[]}function L(t){let e=d.parse(`(${t})`);return x.isMemberExpression(e.program.body[0].expression)}function se(t,e,s){let n=[],r=d.parse(e);d.traverse(r,{Identifier(i){n.push(i.node.name)}});let o=d.parse(`function tempFunc() {${t}}`);return d.traverse(o,{Identifier(i){if(n.includes(i.node.name)&&!M(i.parentPath.node,i.node)&&!j(i.parentPath.node,i.node)){let a=x.memberExpression(x.identifier(s),x.identifier(i.node.name));i.replaceWith(a),i.skip()}}}),d.generate(o.program.body[0].body).trim().replace(/(^\{)|(\}$)/g,"")}function oe(t){let e=d.parse(`let _ = ${t}`).program.body[0].declarations[0].init;return!!(x.isArrowFunctionExpression(e)||x.isFunctionExpression(e))}var D=class{depChain;subViews;idDepsArr=[];constructor(e,s,n=[]){this.depChain=e,this.subViews=s,this.idDepsArr=n}generate(e){let s=new g;for(let[n,r]of e.entries())s.addBody(this.resolveParserNode(r,n));return s.add(`return ${ee(e)};`),s.value}geneDeps(e){return[...new Set([...te(e,this.depChain),...ne(e,this.idDepsArr)])]}resolveParserNode(e,s){return this.subViews.includes(e.tag)?this.resolveSubView(e,s):e.tag==="env"?this.resolveEnv(e,s):e.tag==="_"?this.resolveExpression(e,s):e.tag==="if"?this.resolveIf(e,s):e.tag==="for"?this.resolveFor(e,s):e.tag==="_$text"?this.resolveText(e,s):Q(e)?this.resolveHTML(e,s):(Y(e),this.resolveCustom(e,s))}resolveIf(e,s){let n=new g,r=`_$node${s}`;n.add(`const ${r} = new _$.IfNode();`);for(let o of e.attr.conditions){n.add(`${r}._$addCond(() => ${o.condition}, () => {`),n.add(this.generate(o.parserNodes));let i=this.geneDeps(o.condition);if(i.length>0){n.add(`}, this, ${h(i)});`);continue}n.add("});")}return n}resolveFor(e,s){let n=new g,r=e.attr.key,o=e.attr.item,i=e.attr.array,a=`_$node${s}`;n.add(`const ${a} = new _$.ForNode();`);let p=this.geneDeps(i);if(p.length>0){n.add(`${a}._$addNodeFunc((_$key, _$idx, node_for) => {`);let $=o.match(/[_$a-zA-Z][_$a-zA-Z0-9]*/g)??[];n.add(`const ${o} = node_for._$getItem(_$key, _$idx);`);let l=`_$valuedItem${k()}`;n.add(`const ${l} = {};`);for(let P of $)n.add(`${l}.${P} = ${P};`);n.add(`node_for._$listen(this, ()=>node_for._$getItem(_$key, _$idx),             ${h(p)}, (_$item) => {`),n.add(`const ${o} = _$item;`);for(let P of $)n.add(`${l}.${P} = ${P};`);n.add("});");let N=new D(this.depChain,this.subViews,[...this.idDepsArr,{ids:re(o),propNames:p}]).generate(e.children);N=se(N,o,l),n.add(N),n.add("});"),r&&(n.add(`${a}._$addKeyFunc(() => {`),n.add("const keys = [];"),n.add(`for (let ${o} of ${i}) {`),n.add(`keys.push(${r});`),n.add("}"),n.add("return keys;"),n.add("});")),n.add(`${a}._$addArrayFunc(this, () => (${i}), ${h(p)});`)}else n.add(`${a}._$addNodess(() => Array.from(${i}).map((${o}) => (() => {`),n.add(this.generate(e.children)),n.add("})()));");return n}resolveText(e,s){let n=new g,r=e.attr._$content,o=this.geneDeps(`${r}`),i=`_$node${s}`;return o.length>0?n.add(`const ${i} = new _$.TextNode(() => ${r}, this, ${h(o)});`):n.add(`const ${i} = new _$.TextNode(${r}, );`),n}resolveHTML(e,s){let n=new g,r=`_$node${s}`;n.add(`const ${r} = new _$.HtmlNode(${e.tag}, );`);for(let{key:o,value:i,nodes:a}of e.attr.props){if(i=this.parsePropNodes(i,a),o==="do"){n.add(`(${i})(${r});`);continue}if(o==="forwardProps"){n.add(`this.forwardProps(${r});`);continue}if(["willAppear","didAppear","willDisappear","didDisappear"].includes(o)){n.add(`${r}._$addLifeCycle(${i}, "${o}");`);continue}o==="_$content"&&(o="innerText");let p=this.geneDeps(i);if(o==="element"){n.add(`const ${r}Element = () => ${i} = ${r}._$el;`),n.add(`${r}Element()`),n.add(`this._$addDeps(${h(p)}, {}, ${r}Element)`);continue}if(p.length>0){n.add(`${r}._$addProp("${o}", () => (${i}), this, ${h(p)});`);continue}n.add(`${r}._$addProp("${o}", ${i});`)}return e.children.length>0&&(n.add(`${r}._$addNodes((() => {`),n.add(this.generate(e.children)),n.add("})())")),n}resolveCustom(e,s){let n=new g,r=`_$node${s}`;n.add(`const ${r} = new (${e.tag})();`);for(let{key:o,value:i,nodes:a}of e.attr.props){if(i=this.parsePropNodes(i,a),o==="do"){n.add(`(${i})(${r});`);continue}if(o==="forwardProps"){n.add(`this.forwardProps(${r});`);continue}if(["willMount","didMount","willUnmount","didUnmount"].includes(o)){n.add(`${r}._$addLifeCycle(${i}, "${o}");`);continue}let p=this.geneDeps(i);if(o==="element"){oe(i)?n.add(`const ${r}Element = () => (${i})(${r}._$el);`):n.add(`const ${r}Element = () => ${i} = ${r}._$el;`),n.add(`${r}._$addAfterset(${r}Element);`),n.add(`this._$addDeps(${h(p)}, {}, ${r}Element);`);continue}if(p.length>0){n.add(`${r}._$addProp("${o}", () => (${i}), this, ${h(p)}, ${L(i)});`);continue}n.add(`${r}._$addProp("${o}", ${i});`)}return e.children.length>0&&(n.add(`${r}._$addChildren((() => {`),n.add(this.generate(e.children)),n.add("})())")),n}resolveSubView(e,s){e.attr.isSubView=!0;let n=new g,r=e.attr.props.map(({key:a,value:p,nodes:$})=>({key:a,value:this.parsePropNodes(p,$)})),o=k(),i=[];for(let[a,{key:p,value:$}]of r.entries()){let m=`${p}_${o}`,l=h(this.geneDeps($));n.add(`const ${m} = {value: ${$}, deps: ${l}};`),i.push({key:p,keyWithId:m}),n.add(`const depId${s}_${a} = {};`),n.add(`this._$addDeps(${l}, depId${s}_${a}, () => {${m}.value = ${$}});`)}return n.add(`const _$node${s} = ${e.tag}({${i.map(({key:a,keyWithId:p})=>`${a}: ${p}`).join(", ")}});`),n.add(`_$node${s}[0]._$depObjectIds.push(...[${Object.keys(r).map(a=>`depId${s}_${a}`).join(",")}]);`),n}resolveEnv(e,s){let n=new g,r=`_$node${s}`;n.add(`const ${r} = new _$.EnvNode();`),e.children.length>0&&(n.add(`${r}._$addNodes((() => {`),n.add(this.generate(e.children)),n.add("})())"));for(let{key:o,value:i,nodes:a}of e.attr.props){i=this.parsePropNodes(i,a);let p=this.geneDeps(i);if(p.length>0){n.add(`${r}._$addProp("${o}", () => (${i}), this, ${h(p)}, ${L(i)});`);continue}n.add(`${r}._$addProp("${o}", ${i});`)}return n}resolveExpression(e,s){let n=new g,r=`_$node${s}`;for(let{key:o,value:i,nodes:a}of e.attr.props){if(i=this.parsePropNodes(i,a),o==="_$content"){let $=this.geneDeps(i);$.length>0?n.add(`const ${r} = new _$.ExpressionNode(() => ${i}, this, ${h($)});`):n.add(`const ${r} = new _$.ExpressionNode(${i});`);continue}if(o==="onUpdateNodes"){n.add(`${r}._$onUpdateNodes(${i});`);continue}let p=this.geneDeps(i);if(p.length>0){n.add(`${r}._$addProp("${o}", () => (${i}), this, ${h(p)}, ${L(i)});`);continue}n.add(`${r}._$addProp("${o}", ${i});`)}return n}parsePropNodes(e,s){for(let[n,r]of Object.entries(s)){let o=new g;o.add("((()=>{"),o.add(this.generate(r)),o.add("})())"),e=e.replace('"'+n+'"',o.value)}return e}};function I(t,e,s,n=[]){return new D(e,s,n).generate(t)}var f=E(require("@babel/types"));function we(){return Math.random().toString(32).slice(2)}function ie(t,e){if(!e)return{key:t,value:!0,nodes:{}};let s=d.parse(`let _ = ${d.generate(e)}`),n={};return d.traverse(s,{DoExpression(r){let o=r.node,i=we();n[i]=pe(o.body.body),r.replaceWith(f.stringLiteral(i))}}),{key:t,value:d.generate(s.program.body[0].declarations[0].init),nodes:n}}function Ne(t){for(;t;)if(t=t.callee?.object,f.isCallExpression(t))return!1;return!0}function Ce(t){let e={tag:"",attr:{props:[]},children:[]},s=t;for(;s&&s.callee?.object&&!Ne(s);){let n=s.arguments[0],r=s.callee.property.name;e.attr.props.unshift(ie(r,n)),s=s.callee.object}return s.arguments.length>0&&e.attr.props.unshift(ie("_$content",s.arguments[0])),e.tag=d.generate(s.callee),e}function ke(t){return{tag:"_$text",attr:{_$content:d.generate(t)},children:[]}}function De(t){let e=ae(t.tag);Array.isArray(e)||(e=[e]);let s={tag:"_$text",attr:{_$content:d.generate(t.quasi)},children:[]};return[...e,s]}function ae(t){return f.isCallExpression(t)?Ce(t):f.isStringLiteral(t)||f.isTemplateLiteral(t)?ke(t):f.isTaggedTemplateExpression(t)?De(t):{}}function Ie(t){let e=d.generate(t.left.declarations[0]),s=d.generate(t.right),n={tag:"for",attr:{item:e,array:s},children:[]},r=t.body.body;return f.isArrayExpression(r[0].expression)&&(n.attr.key=d.generate(r[0].expression.elements[0]),r=r.slice(1)),n.children=A(r),n}function Ae(t){return{tag:"if",attr:{conditions:de(t)},children:[]}}function de(t){let e=[],s=d.generate(t.test),n=A(t.consequent.body);return e.push({condition:s,parserNodes:n}),f.isIfStatement(t.alternate)?e.push(...de(t.alternate)):t.alternate&&e.push({condition:!0,parserNodes:A(t.alternate.body)}),e}function A(t){let e=[];for(let s of t)if(f.isExpressionStatement(s)){let n=ae(s.expression);Array.isArray(n)||(n=[n]),e.push(...n)}else f.isBlockStatement(s)?e[e.length-1].children=A(s.body):f.isForOfStatement(s)?e.push(Ie(s)):f.isIfStatement(s)&&e.push(Ae(s));return e}function pe(t){return A(t)}var O=pe;var _=E(require("@babel/types"));function ce(t,e){if(!e)return{key:t,value:!0,nodes:{}};let s=d.parse(d.generate(e)),n={};d.traverse(s,{JSXElement(o){let i=k();n[i]=S([o.node]),o.replaceWith(_.stringLiteral(i))}});let r=d.generate(e);return _.isJSXExpressionContainer(e)&&(r=r.replace(/^\{(.+)\}$/,"$1")),r.trim()===""&&(r='""'),{key:t,value:r,nodes:n}}function Te(t){let e=t.openingElement.name.name,s=[];for(let n of t.openingElement.attributes)n=n,s.push(ce(n.name.name,n.value));return{tag:e,attr:{props:s},children:S(t.children)}}function Be(t){let e=t.value.trim();return e===""?void 0:{tag:"_$text",attr:{_$content:`"${e}"`},children:[]}}function T(t,e){let s=t.openingElement.attributes.find(o=>o.name.name===e);if(!s)return s;let n="",r=s.value;return n=_.isJSXExpressionContainer(r)?d.generate(r.expression):d.generate(r),n}function Fe(t){return{tag:"if",attr:{conditions:[{condition:T(t,"cond"),parserNodes:S(t.children)}]},children:[]}}function Je(t,e){e.attr.conditions.push({condition:T(t,"cond"),parserNodes:S(t.children)})}function Xe(t,e){e.attr.conditions.push({condition:"true",parserNodes:S(t.children)})}function Me(t){return{tag:"for",attr:{item:T(t,"let"),array:T(t,"of"),key:T(t,"key")},children:S(t.children)}}function je(t){return{tag:"_",attr:{props:[ce("_$content",t)]},children:[]}}function S(t){let e=[];for(let s of t){if(_.isJSXText(s)){let r=Be(s);r&&e.push(r);continue}if(_.isJSXExpressionContainer(s)){e.push(je(s));continue}if(_.isJSXFragment(s)){e.push(...S(s.children));continue}let n=s.openingElement.name.name;if(n==="if"){e.push(Fe(s));continue}if(n==="else-if"){Je(s,e[e.length-1]);continue}if(n==="else"){Xe(s,e[e.length-1]);continue}if(n==="for"){e.push(Me(s));continue}e.push(Te(s))}return e}function Le(t){return S([t])}var le=Le;var b=E(require("@babel/types"));function ue(t,e,s,n){let r=t.key.name;t.key.name=`_$$${r}`;let o=e.body.indexOf(t),i=s.map(v=>`if (${v}.preset) value = ${v}.preset(value, this, "${r}")`).join(`
`),a=w(`
    function ${r}() {
        return this._$$${r}
    }`),p=w(`
    function ${r}(value) {
        ${i}
        if (this._$$${r} === value) return
        this._$$${r} = value
        this._$runDeps("${r}")
    }`),[$,m]=q(r,a,p),l=[$,m];if(n!=="State"){let v=b.classProperty(b.identifier(`_$$$${r}`),b.stringLiteral(`_$${n.toLowerCase().replace("state","")}`));l.unshift(v)}e.body.splice(o+1,0,...l)}function fe(t,e,s){let n=t.key.name,r=e.body.indexOf(t),o=s.toLowerCase(),i=b.classProperty(b.identifier(`_$$${n}`),b.stringLiteral(`_$${o}`));e.body.splice(r,0,i)}function $e(t,e,s){let n=t.key.name,r=d.generate(t.value??b.identifier("undefined"));if(!/^[0-9a-zA-z$_]+$/.test(e)){let o=s.body.indexOf(t),i=e.match(/^[0-9a-zA-z$_]+/)[0];s.body.splice(o,0,b.classProperty(b.identifier(`_$$${n}_${i}`),d.parse(e).program.body[0].expression)),e=`this._$$${n}_${i}`}return t.value=d.parse(`(${e}.func??(typeof ${e} === "function" ? ${e} : (_=>_)))(${r}, this, "${n}")`).program.body[0].expression,e}function Oe(t,e,s,n=!1){let r;if(n){let o=t.params[0];if(!o||!c.isObjectPattern(o))r=I(O(t.body.body),e,s);else{let a=o.properties.map(p=>p.key.name).map(p=>({ids:[p],propNames:[`...${p}.deps`]}));r=I(O(t.body.body),e,s,a)}}else r=I(O(t.body.body),e,s);t.body=w(`function tmp() { ${r} }`)}function Ve(t,e,s){let n=I(le(t.value),e,s);t.value=c.arrowFunctionExpression([],w(`function tmp() { ${n} }`))}function We(t){let e=t.params[0];if(!e||!c.isObjectPattern(e))return;let s=[];for(let r of e.properties){let o=r.key.name;s.push(o),c.isAssignmentPattern(r.value)&&(r.value.right=c.objectExpression([c.objectProperty(c.identifier("value"),r.value.right),c.objectProperty(c.identifier("deps"),c.arrayExpression())]))}let n=d.parse(`function tmp() ${d.generate(t.body)}`);d.traverse(n,{Identifier(r){s.includes(r.node.name)&&!M(r.parentPath.node,r.node)&&!j(r.parentPath.node,r.node)&&(r.replaceWith(c.memberExpression(c.identifier(r.node.name),c.identifier("value"))),r.skip())}}),t.body=n.program.body[0].body}function z(t,e,s){let n=s==="jsd"?Oe:Ve,r,o=[];for(let a of t.body)a.decorators?.find(p=>c.isIdentifier(p.expression)&&p.expression.name==="View")?(a.decorators=void 0,o.push(a)):a.key.name==="Body"&&(r=a);let i=o.map(a=>"this."+a.key.name);for(let a of o)We(a),n(a,e,i,!0);n(r,e,i)}function ye(t,e){let s=d.parse(t),n=null,r=null,o=null,i=null,a=[];return d.traverse(s,{enter(m){let l=m.node;(c.isClassDeclaration(l)||c.isClassExpression(l))&&c.isIdentifier(l.superClass,{name:"View"})&&(n=l,r=n.body,i=c.classProperty(c.identifier("_$derivedPairs"),c.objectExpression([])),o=c.classProperty(c.identifier("_$deps"),c.objectExpression([])),a=[])},ClassMethod(m){n&&r.body.indexOf(m.node)===r.body.length-1&&z(r,a,e)},ClassProperty(m){if(!n)return;let l=m.node,v=r.body.indexOf(m.node)===r.body.length-1;if(l.decorators?.find(y=>c.isIdentifier(y.expression)&&y.expression.name==="View")??l.key.name==="Body"){v&&z(r,a,e);return}let N=["EnvState","PropState","State","Prop","Env"],P=[],me=(l.decorators??[]).map(y=>{let V=Z(y);return N.includes(V)?V:(P.push($e(l,V,r)),null)}).filter(y=>y),C=[];m.scope.traverse(l,{MemberExpression(y){a.includes(y.node.property.name)&&X(y,n)&&C.push(y.node.property.name)}}),C=[...new Set(C)],C.length>0&&(H(l.key.name,C,i,r),J(l.key.name,o,r),U(l),a.push(l.key.name));for(let y of me){if(["EnvState","PropState","State"].includes(y)){a.push(l.key.name),J(l.key.name,o,r),ue(l,r,P,y);break}if(["Prop","Env"].includes(y)){a.push(l.key.name),J(l.key.name,o,r),fe(l,r,y);break}}l.decorators=null,v&&z(r,a,e)}}),`import * as _$ from '@dlightjs/dlight';
`+d.generate(s)}0&&(module.exports={parseDlightFile});
